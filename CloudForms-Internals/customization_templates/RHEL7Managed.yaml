---
- name: RHEL7Managed
  description: RHEL7Managed
  script: |
    <%
       evm[:hostname] = evm[:vm_target_hostname] if evm[:hostname].blank?
       script_hostname = evm[:hostname]
       ssh_key = evm[:sshkey]
       script_username = evm[:scriptusername]
    %>#cloud-config

    cloud_init_modules:
     - migrator
     - bootcmd
     - write-files
     - growpart
     - resizefs
     - set_hostname
     - update_hostname
     - update_etc_hosts
     - rsyslog
     - users-groups
     - ssh

    users:
    - name: <%=script_username%>
      ssh-authorized-keys:
      - <%=ssh_key%>
    - name: root
      ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDuqdf1RWW9NLmb1Sa4QyB26lJlLYq8m17FRnVdf24afd6WIKJn6f2aU5GPQEJFL+G5m4Tz8D2OzBK6q2Tup6Wg152ANpOZzfJU7NMopdh+oXHbJWM07QUp7HMOb2SfyMLcAPEgXrJwqCz78dJwea8vZTPwGymZXZw3IW6MabzZKHdHP8dYVK71l73Bbxg/9S1SvLnW2xX1G/zlU2+QRnVrbyARhFTdINejYwHTzozKHK0Zi3HaPZ4aQqXO6HK9Fqh7C+nyKbJaZbLYLxNn2Co+hbCw0gJXDStyU7l3XFrUr3bCgcbZ5adgsAkgoTzAgQaOqCceI402r4if68o+mJJJ root@infra.cd.coe.muc.redhat.com

    hostname: <%=script_hostname%>
    fqdn: <%=script_hostname%>.hailstorm3.coe.muc.redhat.com
    manage_etc_hosts: true

    write_files:
    - path: /tmp/foreman-userdata.sh
      permissions: '0755'
      content: |
       #!/bin/bash

       sleep 60

       # add subscription manager
       # yum -t -y -e 0 install subscription-manager
       # rpm -ivh http://10.32.99.175/pub/katello-ca-consumer-latest.noarch.rpm
       rpm -ivh http://satellite.hailstorm3.coe.muc.redhat.com/pub/katello-ca-consumer-latest.noarch.rpm

       echo "Registering the System"
       subscription-manager register --org="Default_Organization" --name=<%=script_hostname%>.hailstorm3.coe.muc.redhat.com --activationkey="AK-CV-OS-RHEL7-SERVER-TEST"

       # add the rhel rpms to install katello agent
       # subscription-manager repos --enable=rhel-7-server-satellite-tools-{{ satellite_version }}-rpms

       echo "Installing Katello Agent"
       yum -t -y -e 0 install katello-agent
       chkconfig goferd on
       katello-package-upload

    runcmd:
     - [ cloud-init-per, once, foreman-userdata, /tmp/foreman-userdata.sh ]
    output: {all: '| tee -a /root/install.userdata.log'}

    # end of example
  pxe_image_type_id: 919000000000003
  type: CustomizationTemplateCloudInit
  system: 
